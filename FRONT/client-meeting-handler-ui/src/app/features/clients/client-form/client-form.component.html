<!-- src/app/features/clients/client-form/client-form.component.html -->
<div class="container mx-auto p-4">
  <div class="bg-white shadow-md rounded-lg p-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold">{{ isEditMode ? 'Edit Client' : 'Create New Client' }}</h1>
      <button [routerLink]="['/clients']" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
        Back to List
      </button>
    </div>

    <div *ngIf="error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
      {{ error }}
    </div>

    <form [formGroup]="clientForm" (ngSubmit)="onSubmit()" class="space-y-4">
      <!-- Nombre del cliente -->
      <div class="form-group">
        <label for="Name" class="block text-gray-700 text-sm font-bold mb-2">Name:</label>
        <input
          type="text"
          id="Name"
          formControlName="Name"
          class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
          [ngClass]="{'border-red-500': submitted && f['Name'].errors}"
        >
        <div *ngIf="submitted && f['Name'].errors" class="text-red-500 mt-1 text-sm">
          <div *ngIf="f['Name'].errors['required']">Name is required</div>
        </div>
      </div>

      <!-- Selector de contacto con búsqueda -->
      <div class="form-group relative">
        <label for="contactEmail" class="block text-gray-700 text-sm font-bold mb-2">Contact:</label>
        <div class="relative">
          <input
            #contactEmailInput
            type="text"
            id="contactEmail"
            formControlName="contactEmail"
            placeholder="Search by email..."
            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
            (focus)="showContactDropdown = true"
            (blur)="hideDropdown()"
          >
          <!-- Lista desplegable de contactos filtrados -->
          <div *ngIf="showContactDropdown && !createNewContactMode"
               class="absolute z-10 mt-1 w-full bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-auto">
            <!-- Opción para crear nuevo contacto -->
            <div class="cursor-pointer hover:bg-blue-50 p-2 border-b border-gray-100 flex items-center"
                 (mousedown)="toggleCreateNewContact()">
              <span class="text-blue-500 font-bold mr-2">+</span> Create new contact
            </div>

            <!-- Lista de contactos filtrados -->
            <div *ngFor="let contact of filteredContacts"
                 class="cursor-pointer hover:bg-gray-100 p-2 border-b border-gray-100"
                 (mousedown)="selectContact(contact)">
              {{ contact.Email }}
            </div>

            <!-- Mensaje si no hay resultados -->
            <div *ngIf="filteredContacts.length === 0" class="p-2 text-gray-500">
              No contacts found
            </div>
          </div>

          <!-- Modo de creación de nuevo contacto -->
          <div *ngIf="createNewContactMode" class="mt-2 p-3 border border-blue-200 rounded bg-blue-50">
            <p class="text-sm font-medium mb-2">Creating new contact with email: {{ f['contactEmail'].value }}</p>
            <div class="flex space-x-2">
              <button type="button" class="bg-blue-500 hover:bg-blue-700 text-white py-1 px-3 rounded text-sm"
                      (click)="createNewContact()">
                Save Contact
              </button>
              <button type="button" class="bg-gray-500 hover:bg-gray-700 text-white py-1 px-3 rounded text-sm"
                      (click)="toggleCreateNewContact()">
                Cancel
              </button>
            </div>
          </div>
        </div>

        <!-- Campo oculto para el ID del contacto -->
        <input type="hidden" formControlName="ContactId">

        <div *ngIf="submitted && f['ContactId'].errors" class="text-red-500 mt-1 text-sm">
          <div *ngIf="f['ContactId'].errors['required']">Contact selection is required</div>
        </div>
      </div>

      <div class="flex justify-end mt-6">
        <button
          type="button"
          [routerLink]="['/clients']"
          class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded mr-2"
        >
          Cancel
        </button>
        <button
          type="submit"
          class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded"
          [disabled]="loading"
        >
          {{ loading ? 'Saving...' : 'Save' }}
        </button>
      </div>
    </form>
  </div>
</div>
